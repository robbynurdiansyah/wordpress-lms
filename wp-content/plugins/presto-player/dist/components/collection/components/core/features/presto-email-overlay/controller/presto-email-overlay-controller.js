import{h}from"@stencil/core";import{timePassed}from"../../../../../util";export class PrestoEmailOverlayController{constructor(){this.percentagePassed=0}setStorage(e){window.localStorage.setItem("presto.videos.email_collection",JSON.stringify({[this.videoId]:e}))}getStorage(){return window.localStorage.getItem("presto.videos.email_collection")}componentWillLoad(){this.handleDuration()}handleDuration(){var e;this.enabled=!this.getStorage()&&(null===(e=null==this?void 0:this.emailCollection)||void 0===e?void 0:e.enabled),this.handleTimeCheck()}handleTimeCheck(){this.enabled&&(this.getStorage()||this.checkTime())}handleShowChange(){this.show&&this.pauseVideo.emit(!0)}checkTime(){var e;this.show=timePassed({current:this.currentTime,duration:this.duration,showAfter:(null===(e=null==this?void 0:this.emailCollection)||void 0===e?void 0:e.percentage)||0})}async getNonce(){var e;return fetch(`${null===(e=null===window||void 0===window?void 0:window.prestoPlayer)||void 0===e?void 0:e.ajaxurl}?action=presto_refresh_progress_nonce`)}async submit(e){var t;this.loading=!0,this.error="";const o=await this.getNonce(),{data:i}=await o.json();try{let o=await fetch(null===(t=null===window||void 0===window?void 0:window.prestoPlayer)||void 0===t?void 0:t.ajaxurl,{method:"post",body:new URLSearchParams({action:"presto_player_email_submit",nonce:i,preset_id:this.presetId,video_id:this.videoId,provider:this.provider,...(null==e?void 0:e.detail)||{}})});const{success:r,data:l}=await o.json();if(!r)throw l;this.setStorage("collected"),this.show=!1,this.playVideo.emit()}catch(e){const t=null==e?void 0:e[0];t&&"string"==typeof t&&(this.error=t)}finally{this.loading=!1}}skip(){this.setStorage("skipped"),this.show=!1,this.playVideo.emit()}handleEmailStateChange(e){this.emailStateChange.emit(e)}render(){var e,t,o,i,r,l,a,n;if(this.show)return h("presto-email-overlay-ui",{style:{...(null===(e=null==this?void 0:this.emailCollection)||void 0===e?void 0:e.button_color)?{"--presto-player-button-color":`${null===(t=null==this?void 0:this.emailCollection)||void 0===t?void 0:t.button_color}`}:{},...(null===(o=null==this?void 0:this.emailCollection)||void 0===o?void 0:o.button_text_color)?{"--presto-player-button-text":`${null===(i=null==this?void 0:this.emailCollection)||void 0===i?void 0:i.button_text_color}`}:{}},direction:this.direction,class:"email-overlay",headline:null===(r=null==this?void 0:this.emailCollection)||void 0===r?void 0:r.headline,bottomText:null===(l=null==this?void 0:this.emailCollection)||void 0===l?void 0:l.bottom_text,allowSkip:null===(a=null==this?void 0:this.emailCollection)||void 0===a?void 0:a.allow_skip,buttonText:null===(n=null==this?void 0:this.emailCollection)||void 0===n?void 0:n.button_text,isLoading:this.loading,errorMessage:this.error,onSubmitForm:e=>this.submit(e),onSkip:()=>this.skip(),i18n:this.i18n,provider:this.provider})}static get is(){return"presto-email-overlay-controller"}static get originalStyleUrls(){return{$:["presto-email-overlay-controller.css"]}}static get styleUrls(){return{$:["presto-email-overlay-controller.css"]}}static get properties(){return{ended:{type:"boolean",attribute:"ended",mutable:!1,complexType:{original:"boolean",resolved:"boolean",references:{}},required:!1,optional:!1,docs:{tags:[],text:""},getter:!1,setter:!1,reflect:!1},currentTime:{type:"number",attribute:"current-time",mutable:!1,complexType:{original:"number",resolved:"number",references:{}},required:!1,optional:!1,docs:{tags:[],text:""},getter:!1,setter:!1,reflect:!0},duration:{type:"number",attribute:"duration",mutable:!1,complexType:{original:"number",resolved:"number",references:{}},required:!1,optional:!1,docs:{tags:[],text:""},getter:!1,setter:!1,reflect:!0},direction:{type:"string",attribute:"direction",mutable:!1,complexType:{original:"'rtl'",resolved:'"rtl"',references:{}},required:!1,optional:!0,docs:{tags:[],text:""},getter:!1,setter:!1,reflect:!1},emailCollection:{type:"unknown",attribute:"email-collection",mutable:!1,complexType:{original:"EmailCollection",resolved:"EmailCollection",references:{EmailCollection:{location:"import",path:"../../../../../interfaces",id:"src/interfaces.ts::EmailCollection"}}},required:!1,optional:!0,docs:{tags:[],text:""},getter:!1,setter:!1},i18n:{type:"unknown",attribute:"i-1-8n",mutable:!1,complexType:{original:"i18nConfig",resolved:"i18nConfig",references:{i18nConfig:{location:"import",path:"../../../../../interfaces",id:"src/interfaces.ts::i18nConfig"}}},required:!1,optional:!1,docs:{tags:[],text:""},getter:!1,setter:!1},videoId:{type:"number",attribute:"video-id",mutable:!1,complexType:{original:"number",resolved:"number",references:{}},required:!1,optional:!1,docs:{tags:[],text:""},getter:!1,setter:!1,reflect:!1},presetId:{type:"number",attribute:"preset-id",mutable:!1,complexType:{original:"number",resolved:"number",references:{}},required:!1,optional:!1,docs:{tags:[],text:""},getter:!1,setter:!1,reflect:!1},provider:{type:"string",attribute:"provider",mutable:!1,complexType:{original:"string",resolved:"string",references:{}},required:!1,optional:!1,docs:{tags:[],text:""},getter:!1,setter:!1,reflect:!1}}}static get states(){return{enabled:{},show:{},loading:{},error:{},percentagePassed:{}}}static get events(){return[{method:"playVideo",name:"playVideo",bubbles:!0,cancelable:!0,composed:!0,docs:{tags:[],text:""},complexType:{original:"void",resolved:"void",references:{}}},{method:"pauseVideo",name:"pauseVideo",bubbles:!0,cancelable:!0,composed:!0,docs:{tags:[],text:""},complexType:{original:"true",resolved:"boolean",references:{}}},{method:"restartVideo",name:"restartVideo",bubbles:!0,cancelable:!0,composed:!0,docs:{tags:[],text:""},complexType:{original:"void",resolved:"void",references:{}}},{method:"emailStateChange",name:"emailStateChange",bubbles:!0,cancelable:!0,composed:!0,docs:{tags:[],text:""},complexType:{original:"boolean",resolved:"boolean",references:{}}}]}static get watchers(){return[{propName:"duration",methodName:"handleDuration"},{propName:"currentTime",methodName:"handleTimeCheck"},{propName:"currentTime",methodName:"handleShowChange"},{propName:"show",methodName:"handleEmailStateChange"}]}}